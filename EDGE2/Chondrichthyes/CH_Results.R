##### In this run we are going to read in the 100 results files generated by the HPC run 
# we are going to look at all the resultant PD losses and and create a 'master' edge scores data-frame

# Housekeeping
rm(list=ls())
graphics.off()
setwd("~/Documents/EDGE2/Chondrichthyes/")


# first things first: packages
#install.packages("wesanderson")
library(wesanderson)
library(ape)
library(caper)
library(data.table)
require(geiger)
require(pez)
require(phytools)
require(phylobase)

## now lets IMPORT THOSE DATAAAAAAAAAAAAA
load("Results/Ch_HPCResults.Rdata")


# now we're puting all the edge scores together
all.edge.scores <- data.frame(matrix(nrow = length(EDGE.2.list[[1]]$Species), ncol = 1001))

all.edge.scores[1] <- as.character(EDGE.2.list[[1]]$Species)     

for (i in 1:1000) {
  # select entry in the list
  print(i)
  res.use <- EDGE.2.list[[i]]
  if (!is.na(res.use)) {
    for (j in 1:length(all.edge.scores$X1)) {
      # match all ofthe species and enter into data.frame
      ref <- match(all.edge.scores$X1[j], res.use$Species)
      all.edge.scores[j,(i + 1)] <- res.use$EDGE[ref]
      #print(j)
  }}}
    
save(all.edge.scores, file = "Results/Ch_EDGE2_Scores.Rdata")


# add in mean and median EDGE scores
library(tidyr)

all.edge.scores$meanEDGE <-  rowMeans(all.edge.scores[,c(2:length(all.edge.scores))], na.rm = T)
all.edge.scores$medianEDGE <- apply(all.edge.scores[,c(2:length(all.edge.scores))], MARGIN = 1, FUN = median)


# save all.edge.scores down again!

save(all.edge.scores, file = "Results/Ch_EDGE2_Scores.Rdata")
load(file = "Results/Ch_EDGE2_Scores.Rdata")


#### now lets calculate PD loss!

pd.loss <- data.frame(matrix(nrow = length(EDGE.2.list), ncol = 4))
colnames(pd.loss) <- c("TreeNo", "TreePD", "PDLoss", "ePD")
pd.loss$TreeNo <- c(1:1000)

# step one - now lets add in the data collected 

pd.loss$ePD <- pd.loss$TreePD - pd.loss$PDLoss
pd.loss$lossPercentage <- pd.loss$PDLoss / pd.loss$TreePD * 100

save(pd.loss, file = "../Results/HPC_EDGE/PDLoss_100.Rdata")

##


 
######### plotting

# find the top20 species
top.20.spp <- subset(all.edge.scores, all.edge.scores$meanEDGE >= 9.2)

top.20.median <- top.20.spp[order(top.20.spp$medianEDGE, decreasing = T),]
top.20.spp <- top.20.median

no <- c()

for (x in 1:9) {
  temp <- paste(0, x, sep = "")
  no <- c(no, temp)
}

numbers <- c(no, 10:20)

names <- c()
for (i in 1:20){
  temp <- paste(numbers[i], top.20.spp$X1[i], sep = "_")
  names <- c(names, temp)
}


# now putting the data into longform

long.df <- data.frame(Species = rep(names, 1000), EDGE = NA)

ledge <- c()

for (i in 2:1001) {
  temp <- as.vector(top.20.spp[,i])
  ledge <- c(ledge, temp)
}

long.df$EDGE <- ledge


# now plot
axislabels <- gsub("_", " ", top.20.median$X1)

graphics.off()
plot.new()
pdf("Results/Ch_Top20Species.pdf")
par(mar = c(16,4,2,1))
boxplot(long.df$EDGE ~ long.df$Species, 
        main = "Range in EDGE2 scores of top 20 Chondrichthyes Species",
        frame = F, 
        col = "steelblue1",
        xlab = NA,
        ylab = "EDGE2 Score",
        xaxt = 'n')

axis(side = 1, at = 1:20, labels = axislabels, las = 2)
dev.off()


to.send <- data.frame(Species = axislabels, meanEDGE <- top.20.spp$meanEDGE)




